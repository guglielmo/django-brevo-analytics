{% extends "admin/base_site.html" %}
{% load static brevo_filters %}

{% block title %}Email List{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<style>
    .email-list-container {
        padding: 20px;
    }
    .list-header {
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .search-form {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .search-form input[type="text"],
    .search-form input[type="date"] {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    .search-form button {
        padding: 8px 16px;
        background-color: #417690;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .search-form button:hover {
        background-color: #2e5266;
    }
    table.dataTable tbody tr {
        cursor: pointer;
    }
    table.dataTable tbody tr:hover {
        background-color: #f5f5f5;
    }
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    .status-sent {
        background-color: #f5f5f5;
        color: #666;
    }
    .status-delivered {
        background-color: #e8f5e9;
        color: #2e7d32;
    }
    .status-opened {
        background-color: #e3f2fd;
        color: #1565c0;
    }
    .status-clicked {
        background-color: #fff3e0;
        color: #e65100;
    }
    .status-bounced {
        background-color: #ffebee;
        color: #c62828;
    }
    .status-unsubscribed {
        background-color: #f5f5f5;
        color: #666;
    }
    .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='brevo_analytics' %}">Brevo Analytics</a>
    &rsaquo; Email List
</div>
{% endblock %}

{% block content %}
<div class="email-list-container">
    <div class="list-header">
        <h1>Email List</h1>
        <form method="get" class="search-form">
            <input type="text" name="q" placeholder="Search by recipient or subject" value="{{ request.GET.q }}">
            <input type="date" name="date_from" placeholder="From date" value="{{ request.GET.date_from }}">
            <input type="date" name="date_to" placeholder="To date" value="{{ request.GET.date_to }}">
            <button type="submit">Filter</button>
            {% if request.GET.q or request.GET.date_from or request.GET.date_to %}
                <a href="{% url 'admin:brevo_analytics_email_list' %}" style="padding: 8px 16px; text-decoration: none; color: #666;">Clear</a>
            {% endif %}
        </form>
    </div>

    {% if emails %}
        <table id="emailTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Recipient</th>
                    <th>Template</th>
                    <th>Subject</th>
                    <th>Sent Date</th>
                    <th>Age</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for email in emails %}
                <tr data-url="{% url 'admin:brevo_analytics_email_detail' email.id %}">
                    <td>{{ email.recipient_email }}</td>
                    <td>{{ email.template_name|default:"â€”" }}</td>
                    <td>{{ email.subject|truncatewords:10 }}</td>
                    <td>{{ email.sent_at|date:"Y-m-d H:i" }}</td>
                    <td style="white-space: nowrap;">{{ email.sent_at|time_since_sent }}</td>
                    <td>
                        {% if email.current_status == 'clicked' %}
                            <span class="status-badge status-clicked">Clicked</span>
                        {% elif email.current_status == 'opened' %}
                            <span class="status-badge status-opened">Opened</span>
                        {% elif email.current_status == 'delivered' %}
                            <span class="status-badge status-delivered">Delivered</span>
                        {% elif email.current_status == 'bounced' %}
                            <span class="status-badge status-bounced">Bounced</span>
                        {% else %}
                            <span class="status-badge status-sent">Sent</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="no-data">
            <p>No emails found.</p>
            {% if request.GET.q or request.GET.date_from or request.GET.date_to %}
                <p>Try adjusting your search filters.</p>
            {% endif %}
        </div>
    {% endif %}
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
    $(document).ready(function() {
        var table = $('#emailTable').DataTable({
            order: [[3, 'desc']], // Sort by sent date descending
            pageLength: 25,
            lengthMenu: [[25, 50, 100], [25, 50, 100]],
            language: {
                search: "Search table:",
                lengthMenu: "Show _MENU_ entries",
                info: "Showing _START_ to _END_ of _TOTAL_ emails",
                infoEmpty: "No emails to display",
                infoFiltered: "(filtered from _MAX_ total emails)",
                zeroRecords: "No matching emails found"
            },
            columnDefs: [
                { orderable: true, targets: [0, 1, 2, 3, 4, 5] }
            ]
        });

        // Make rows clickable
        $('#emailTable tbody').on('click', 'tr', function() {
            var url = $(this).data('url');
            if (url) {
                window.location.href = url;
            }
        });
    });
</script>
{% endblock %}
